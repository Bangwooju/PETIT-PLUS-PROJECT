<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ topic }} 분석 결과</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .prose h2 { color: #60a5fa; font-size: 1.5rem; margin-top: 2rem; border-left: 4px solid #3b82f6; padding-left: 1rem; margin-bottom: 1rem; font-weight: 700; }
        .prose h3 { color: #34d399; font-size: 1.25rem; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 600; }
        .prose p { margin-bottom: 1rem; line-height: 1.7; color: #cbd5e1; }
        .prose a { color: #f87171; text-decoration: underline; }
        #chat-box::-webkit-scrollbar { width: 6px; }
        #chat-box::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen py-12 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <a href="/" class="text-blue-400 hover:text-blue-300 transition-all font-bold">
                <i class="fa-solid fa-arrow-left mr-2"></i> 목록으로 돌아가기
            </a>
            <a href="/download_pdf/{{ topic }}/{{ index }}" class="bg-red-600 hover:bg-red-500 text-white px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg transition-all active:scale-95">
                <i class="fa-solid fa-file-pdf"></i> PDF로 저장
            </a>
        </div>
        
        <div class="bg-slate-800 rounded-3xl p-8 shadow-2xl border border-slate-700 mb-8">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-6 border-b border-slate-700 pb-4">
                {{ topic }} 기술 분석 리포트
            </h1>
            <div id="raw-report" style="display:none;">{{ report }}</div>
            <div id="content" class="prose prose-invert max-w-none"></div>
        </div>

        <div class="bg-slate-800 rounded-3xl p-6 border border-blue-500/30 shadow-xl">
            <h3 class="text-xl font-bold mb-6 text-blue-400 flex items-center gap-2">
                <i class="fa-solid fa-robot"></i> 에이전트 상세 문답
            </h3>
            <div id="chat-box" class="space-y-4 mb-6 max-h-[400px] overflow-y-auto p-4 bg-slate-900/50 rounded-2xl border border-slate-700/50">
                {% for chat in chats %}
                <div class="text-right"><span class="inline-block bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-tr-none text-sm shadow-md mb-2">{{ chat.user }}</span></div>
                <div class="text-left mb-4">
                    <div class="hidden-raw-chat" style="display:none;">{{ chat.ai }}</div>
                    <div class="inline-block bg-slate-800 border border-slate-700 px-4 py-3 rounded-2xl rounded-tl-none text-sm text-slate-200 chat-ai-render prose-sm prose-invert"></div>
                </div>
                {% endfor %}
            </div>
            <div class="flex gap-3">
                <input type="text" id="chat-input" onkeypress="if(event.keyCode==13) sendChat()" placeholder="질문을 입력하세요..." class="flex-grow bg-slate-900 border border-slate-700 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="sendChat()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 rounded-2xl font-bold">전송</button>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            // 리포트 렌더링 (제목 버그 방지)
            const raw = document.getElementById('raw-report').textContent.trim();
            document.getElementById('content').innerHTML = marked.parse(raw);
            
            // 기존 채팅 렌더링
            document.querySelectorAll('.hidden-raw-chat').forEach((raw, i) => {
                document.querySelectorAll('.chat-ai-render')[i].innerHTML = marked.parse(raw.textContent.trim());
            });
            const box = document.getElementById('chat-box');
            box.scrollTop = box.scrollHeight;
        };

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            if (!input.value.trim()) return;

            box.innerHTML += `<div class="text-right mb-4"><span class="bg-blue-600 px-4 py-2 rounded-2xl text-sm shadow-md">${input.value}</span></div>`;
            const query = input.value;
            input.value = '';

            const res = await fetch(`/chat/{{ topic }}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query: query})
            });
            const data = await res.json();
            box.innerHTML += `<div class="text-left mb-4"><div class="bg-slate-800 border border-slate-700 px-4 py-3 rounded-2xl text-sm prose prose-sm prose-invert">${marked.parse(data.answer)}</div></div>`;
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>